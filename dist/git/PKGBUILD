# Maintainer: adogecheems <https://mmoe.work>
pkgname=monika-after-story-git
pkgver=0.12.17
pkgrel=1
pkgdesc="A mod for the free game Doki Doki Literature Club from Team Salvato, which builds on Act 3 to create a simulator of your eternal life with Monika."
arch=('i686' 'x86_64')
url="https://github.com/adogecheems/monika-after-story-linux"
license=('custom')
makedepends=(
    'unzip'
    'xorg-server-xvfb'
)
optdepends=('polkit: for possible privilege escalation')
provides=('monika-after-story')
source=(
    "https://raw.githubusercontent.com/adogecheems/monika-after-story-linux/main/resources/DDLC.tar.xz"
    "https://raw.githubusercontent.com/adogecheems/monika-after-story-linux/main/resources/0utils.rpy"
    "https://raw.githubusercontent.com/adogecheems/monika-after-story-linux/main/resources/config.py"
    "https://raw.githubusercontent.com/adogecheems/monika-after-story-linux/main/resources/mas.png"
    "https://github.com/Monika-After-Story/MonikaModDev/releases/download/v$pkgver/Monika_After_Story-$pkgver-Mod.zip"
    "mas.desktop"
)
noextract=(
    "Monika_After_Story-$pkgver-Mod.zip"
)
prepare() {
    unzip -o -q "$srcdir/Monika_After_Story-$pkgver-Mod.zip" -d "$srcdir/DDLC"

    mv -f "$srcdir/0utils.rpy" "$srcdir/DDLC/game/0utils.rpy"
    mv -f "$srcdir/config.py" "$srcdir/DDLC/renpy/config.py"
}
build () {
    cd "$srcdir/DDLC"
    
    xvfb-run --auto-servernum --server-args='-screen 0 1024x768x24' bash -c '
        ./DDLC.sh &
        pid=$!
        while [ ! -f game/masrun ]; do
            sleep 1
        done
        kill $pid
    '
}
package() {
    install -Dm644 "$srcdir/mas.png" "$pkgdir/usr/share/icons/hicolor/512x512/apps/mas.png"
    install -Dm644 "$srcdir/mas.desktop" "$pkgdir/usr/share/applications/mas.desktop"

    cp -r "$srcdir/DDLC/"* "$pkgdir/opt/monika-after-story"
    chmod +x "$pkgdir/opt/monika-after-story/DDLC.sh"
    chmod +x "$pkgdir/opt/monika-after-story/lib/linux-x86_64/DDLC"
    chmod +x "$pkgdir/opt/monika-after-story/lib/linux-i686/DDLC"
}
